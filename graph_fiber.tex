
\graphicspath{{./Figure/Figure5/}}
\begin{figure}
  \centering
	
  % Define the properties of the different blocks
  \tikzstyle{module}=[draw, draw=blue!80, text width=10em, 
  text centered, minimum height=5em, minimum width = 15em, drop shadow, rounded corners,
  fill=blue!30]

  \tikzstyle{vecArrow} = [thick, decoration={markings,mark=at position
    1 with {\arrow[semithick]{open triangle 60}}},
  double distance=1.4pt, shorten >= 5.5pt,
  preaction = {decorate},
  postaction = {draw,line width=1.4pt, white,shorten >= 4.5pt}]

  % Define distances for bordering
  \def\blockdist{1.5}
  \def\edgedist{2.5}

  \begin{tikzpicture}[node distance=3cm,thick,scale=0.4, every node/.style={scale=0.4},path image/.style={
      path picture={
        \node at (path picture bounding box.center) {
          \includegraphics[width=1cm]{#1}
        };}}]
    \tikzstyle{conefill} = [path image=,fill opacity=0.8]

    % First block with the pre-processing
    %\node[module=above:pre] (pre) at (4.5,-2.6) {\Large Background\\ Subtraction};
    \node[module=above:seg] (seg) at (4.5,-2.6) {\Large Background\\ Subtraction};
    %\node[module,below of=seg] (reg) {\Large Contrast\\ Enhancement};
    %\draw[->] (pre)--(seg);
    %\draw[->] (seg)--(reg);
    \begin{pgfonlayer}{background}
      \path (seg.west |- seg.north)+(-0.9,1.0+\blockdist) node (a) {};
      \path (seg.east |- seg.south)+(+0.9,-0.5) node (b) {};
      
      \path[fill=blue!10,rounded corners, draw=blue!20, dashed] (a) rectangle (b);
    \end{pgfonlayer}
    \path (pre.north) +(0,+\blockdist) node (bgreg) {\Large Pre-processing};

    % Second block with the segmentation
    \begin{scope}[node distance=3cm]
      \node[module] (det) [right=0cm and 2cm of seg] {\Large Region\\Growing};
    \end{scope}
    \node[module,below of=det] (can) {\Large Canny\\ Edge Detector};
    \begin{pgfonlayer}{background}
      \path (det.west |- det.north)+(-0.9,1.0+\blockdist) node (c) {};
      \path (can.east |- can.south)+(+0.9,-0.5) node (d) {};
      \path[fill=blue!10,rounded corners, draw=blue!20, dashed] (c) rectangle (d);
    \end{pgfonlayer}

    
    \draw[->] (det)--(can);

    \path (det.north) +(0,+\blockdist) node (bgreg) {\Large Segmentation};

    % % Define the place where the arrow should start anf finish
    % \path (seg.east |- seg.north)+(+0.9,0) node (e) {};
    % \path (det.west |- seg.north)+(-0.8,0) node (f) {};

    % \draw[double distance =3pt,preaction={-triangle 90,thin,draw,shorten >=-1mm}] (e) -- (f) node[midway,above] {\Large Regularized data};

    % Third block with the merging
    \begin{scope}[node distance=3cm]
      \node[module] (mer) [right=0cm and 2cm of det] {\Large Algebraic\\ Fitting};
    \end{scope}
    \begin{pgfonlayer}{background}
      \path (mer.west |- mer.north)+(-0.9,1.0+\blockdist) node (c) {};
      \path (mer.east |- mer.south)+(+0.9,-0.5) node (d) {};
      \path[fill=blue!10,rounded corners, draw=blue!20, dashed] (c) rectangle (d);
    \end{pgfonlayer}

    \path (mer.north) +(0,+\blockdist) node (bgreg) {\Large Fitting};

    \begin{scope}[yshift=-85,xshift=950]
      \transparent{1.0}\draw[path image=fig9d.png] (0,0) rectangle (1.0,1.0);
      \path (0,0)+(0.5,1.6) node {\Large Det. Img.};
    \end{scope}

    \begin{scope}[yshift=-60,xshift=606]
      \transparent{1.0}\draw[path image=fig9c.png] (0,0) rectangle (1.0,1.0);
      \path (0,0)+(0.0,1.8) node {\Large Seg. Img.};
    \end{scope}

    \begin{scope}[yshift=-60,xshift=282]
      \transparent{1.0}\draw[path image=th_im.png] (0,0) rectangle (1.0,1.0);
      \path (0,0)+(0.0,1.8) node {\Large Enh. Img.};
    \end{scope}

    \begin{scope}[yshift=-85),xshift=-70]
      \transparent{1.0}\draw[path image=th_im_2.png] (0,0) rectangle (1.0,1.0);
      \path (0,0)+(0.0,1.8) node {\Large Thermal Image};
    \end{scope}

    \path (seg.west |- seg.north)+(-2.5,-1) node (i) {};
    \path (seg.west |- seg.north)+(-0.9,-1) node (j) {};
    \draw[double distance =3pt,preaction={-triangle 90,thin,draw,shorten >=-1mm}] (i) -- (j);
    
    \path (seg.east |- seg.north)+(0.9,-1) node (ii) {};
    \path (det.west |- det.north)+(-0.9,-1) node (jj) {};
    \draw[double distance =3pt,preaction={-triangle 90,thin,draw,shorten >=-1mm}] (ii) -- (jj);

    \path (det.east |- det.north)+(0.9,-1) node (ii) {};
    \path (mer.west |- mer.north)+(-0.9,-1) node (jj) {};
    \draw[double distance =3pt,preaction={-triangle 90,thin,draw,shorten >=-1mm}] (ii) -- (jj);

    \path (mer.east |- mer.north)+(0.9,-1) node (ii) {};
    \path (mer.east |- mer.north)+(2.5,-1) node (jj) {};
    \draw[double distance =3pt,preaction={-triangle 90,thin,draw,shorten >=-1mm}] (ii) -- (jj);   
    
  \end{tikzpicture}

  
	\caption{Image processing work-flow to infer the fiber orientation.}
  \label{fig:wkfiber}
\end{figure}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../../../master"
%%% End:
